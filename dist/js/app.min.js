(function(){
  'use strict';



  function config($locationProvider, $routeProvider,$httpProvider) {
    $locationProvider.html5Mode(true);

    $routeProvider
      .when('/', {
        templateUrl: 'views/cinema-billboard.tpl.html',
        controller: 'BillboardCtrl',
        controllerAs: 'billboard'
      })
      .when('/movies/:movie', {
        templateUrl: 'views/cinema-movie.tpl.html',
        controller: 'MovieCtrl',
        controllerAs: 'movie'
      })
      .when('/rooms/:room', {
        templateUrl: 'views/cinema-room.tpl.html',
        controller: 'RoomCtrl',
        controllerAs: 'room'
      })
      .when('/shows/:show', {
        templateUrl: 'views/cinema-show.tpl.html',
        controller: 'ShowCtrl',
        controllerAs: 'show'
      })
      .when('/bookings/:booking', {
        templateUrl: 'views/cinema-booking.tpl.html',
        controller: 'BookingCtrl',
        controllerAs: 'booking'
      });
    delete $httpProvider.defaults.headers.common['X-Requested-With'];
  }

  angular
    .module('cinema', ['ngRoute', 'cinema.controllers', 'cinema.templates'])
    .config(config);

})();

(function(){
  'use strict';

  angular.module('cinema.controllers', ['cinema.services']);

  function LoginCtrl(User, $scope, $timeout){
    var self = this;

    $scope.logged = false;
    $scope.me = {};
    $scope.login = function(){

      console.log($scope.userID);
      User.get({userID: $scope.userID})
      .$promise.then(
         //Success
         function(data){


               $scope.logged = true;
               $scope.me = data;

         },
         //Error
         function(error){
           console.log('Error' + error);
         }
       );

    };

  }
  function BillboardCtrl(Movie, Room){

    this.movies = Movie.query();
    this.rooms = Room.query();

  }

  function MovieCtrl($routeParams, $scope, $location, Movie, Room, ShowsByMovie){
    var self = this;
    self.data = Movie.get({movieID: $routeParams.movie});
    ShowsByMovie.query({movieID: $routeParams.movie})
      .$promise.then(function(data){
        self.shows = data;
        angular.forEach(self.shows, function(value, key) {

          value.room = Room.get({roomID: value.idPlace});
        });
      },
      function(error){
        console.log(error);
      });

    self.viewShow = function(obj){
      $location.path('/shows/'+obj.id);
    };



  }


  function ShowCtrl($routeParams, $scope, $location, Show, Movie, Room, Reservation){
    var self = this;
    var seats, myseats;

    var parseSeats = function(obj){
      var i, j;
      var row = JSON.parse(obj).row,
          col = JSON.parse(obj).col;
      // Crear array primera vez
      var x = new Array(row);
      for (i = 0; i < row; i++) {
        x[i] = new Array(col);
        for (j = 0; j < col; j++) {
          x[i][j] = {ocupado: 0, desactivado: 0};
        }
      }
      return x;
    };


    self.data = Show.get({showID: $routeParams.show}, function(){
      self.movie = Movie.get({movieID: self.data.idMovie});
      self.room = Room.get({roomID: self.data.idPlace}, function(){
        if(self.data.sites === ''){
          self.seats = parseSeats(self.room.places);
        }
        else{
          self.seats = JSON.parse(self.data.sites);
        }
        self.myseats = parseSeats(self.room.places);
      });


    });



    $scope.changeStatus = function(x,y){
      if(self.myseats[x][y].me === undefined){
        self.myseats[x][y].me = 1;
      }
      else{
       self.myseats[x][y].me = !self.myseats[x][y].me;
      }
      self.seats[x][y].ocupado = !self.seats[x][y].ocupado;
    };
    self.send = function(){

      // Create new reserve
      var newReserve = new Reservation();
      newReserve.idShow = self.data.id;
      newReserve.idUser = 1; // asignaciÃ³n fija -> actualizar desde formulario de usuario
      newReserve.sites = self.myseats;

      newReserve.$save(function(u, putResponseHeaders) {
        //u => saved user object

        // Update seats filled
        // Show.update({showID: self.data.id}, self.seats);

        // Load reserves view
        $location.path('/bookings/'+u.id);
      });




    };
  }

  function BookingCtrl($routeParams, Reservation, Show, Movie, Room){
    var self = this;
    function filterByProperty(array, prop, value){
        var filtered = [];
        for(var i = 0; i < array.length; i++){

            var obj = array[i];

            for(var key in obj){
                if(typeof(obj[key] == "object")){
                    var item = obj[key];
                    if(item[prop] == value){
                        var row = i;
                        var col = parseInt(key) +1;
                        var numSeat = row+''+col;
                        filtered.push(numSeat);
                    }
                }
            }

        }
        return filtered;

    }


    self.data = Reservation.get({reservationID: $routeParams.booking}, function(){
      self.seats = filterByProperty(JSON.parse(self.data.sites), 'me', 1);
      self.show = Show.get({showID: self.data.idShow}, function(){
        self.movie = Movie.get({movieID: self.show.idMovie});
        self.room = Room.get({roomID: self.show.idPlace});
      });

    });
  }
  angular.module('cinema.controllers')
    .controller('LoginCtrl', LoginCtrl)
    .controller('BillboardCtrl', BillboardCtrl)
    .controller('ShowCtrl', ShowCtrl)
    .controller('BookingCtrl', BookingCtrl)
    .controller('MovieCtrl', MovieCtrl);
})();

(function(){
  'use strict';
  // Menu settings
      $('#menuToggle, .menu-close').on('click', function(){
        $('#menuToggle').toggleClass('active');
        $('body').toggleClass('body-push-toleft');
        $('#theMenu').toggleClass('menu-open');
      });




})(jQuery);

(function(){
  'use strict';

  angular.module('cinema.services', ['ngResource']);

  function User ($resource, BaseUrl) {
    return $resource(BaseUrl + '/users/:userID',{userID: '@_id'});
  }

  function Movie ($resource, BaseUrl) {
    return $resource(BaseUrl + '/movies/:movieID', {movieID: '@_id'});
  }

  function Room ($resource, BaseUrl) {
    return $resource(BaseUrl + '/rooms/:roomID', {roomID: '@_id'}, {'update': {method: 'PUT'}});
  }

  function Show ($resource, BaseUrl) {
    return $resource(BaseUrl + '/shows/:showID', {showID: '@_id'}, {'update': {method: 'PUT'}});
  }

  function ShowsByMovie($resource, BaseUrl){
    return $resource(BaseUrl + '/shows/movie/:movieID', {movieID: '@_id'});
  }

  function ShowsByRoom($resource, BaseUrl){
    return $resource(BaseUrl + '/shows/movie/:movieID', {movieID: '@_id'});
  }

  function Reservation ($resource, BaseUrl) {
    return $resource(BaseUrl + '/bookings/:reservationID',{reservationID: '@_id'});
  }
  angular
    .module('cinema.services')
    .constant('BaseUrl', 'http://labs.davidtaboas.es/cinema/api')
    .factory('User',User)
    .factory('Room',Room)
    .factory('Show',Show)
    .factory('ShowsByMovie',ShowsByMovie)
    .factory('ShowsByRoom',ShowsByRoom)
    .factory('Reservation',Reservation)
    .factory('Movie',Movie);
})();

angular.module("cinema.templates", []).run(["$templateCache", function($templateCache) {$templateCache.put("views/cinema-billboard.tpl.html","<div class=\"content-fluid\" id=\"movies\">\n  <div class=\"row\">\n    <h3>MOVIES</h3>\n    <p class=\"centered\"><i class=\"fa fa-circle\"></i><i class=\"fa fa-circle\"></i><i class=\"fa fa-circle\"></i></p>\n    <div class=\"items\">\n      <div class=\"item col-md-3 col-sm-6\" ng-repeat=\"movie in billboard.movies\" style=\"background-image: url({{movie.Poster}});\">\n        <a href=\"/movies/{{movie.imdbID}}\"></a>\n        <h4>{{ movie.Title }}</h4>\n        <p class=\"info\"><i class=\"fa fa-star\"></i>{{movie.imdbRating}}</p>\n      </div>\n    </div>\n    <div class=\"col-lg-6 col-lg-offset-3\">\n    </div>\n  </div>\n</div>\n<div class=\"content-fluid\" id=\"rooms\">\n  <div class=\"row\">\n    <h3>Rooms</h3>\n    <p class=\"centered\"><i class=\"fa fa-circle\"></i><i class=\"fa fa-circle\"></i><i class=\"fa fa-circle\"></i></p>\n    <div class=\"items\">\n      <div class=\"item col-md-3 col-sm-6\" ng-repeat=\"room in billboard.rooms\" style=\"background-image: url({{room.Poster}});\">\n        <a href=\"/rooms/{{room.id}}\"></a>\n        <h4>{{ room.name }}</h4>\n      </div>\n    </div>\n    <div class=\"col-lg-6 col-lg-offset-3\">\n    </div>\n  </div>\n</div>\n\n");
$templateCache.put("views/cinema-booking.tpl.html","<div class=\"container\" id=\"booking\">\n  <div class=\"row\">\n    <!-- info film -->\n\n\n    <h3>Your tickets</h3>\n    <p class=\"centered\"><i class=\"fa fa-circle\"></i><i class=\"fa fa-circle\"></i><i class=\"fa fa-circle\"></i></p>\n    <h2>{{booking.movie.Title}}</h2>\n    <h4>{{booking.room.name}}</h4>\n    <div class=\"alert alert-success\" role=\"alert\" ng-repeat=\"seat in booking.seats\">\n      <strong>Seat:</strong> {{seat}}\n    </div>\n    <div class=\"col-lg-6 col-lg-offset-3\">\n    </div>\n  </div>\n</div>\n");
$templateCache.put("views/cinema-movie.tpl.html","<div class=\"container\" id=\"movie\">\n  <div class=\"row\">\n    <!-- info film -->\n  </div>\n  <div class=\"row\">\n    <!-- info shows -->\n    <div class=\"info-movie\">\n      <img src=\"{{movie.data.Poster}}\" />\n      <h2>{{movie.data.Title}}</h2>\n      <p class=\"rating\"><span class=\"fa fa-star fa-1x\"></span>{{movie.data.imdbRating}}</p>\n    </div>\n    <h3>You can view the film in...</h3>\n    <p class=\"centered\"><i class=\"fa fa-circle\"></i><i class=\"fa fa-circle\"></i><i class=\"fa fa-circle\"></i></p>\n    <div class=\"info-rooms\">\n      <div class=\"alert alert-info\" role=\"alert\" ng-repeat=\"item in movie.shows\" ng-click=\"movie.viewShow(item)\">\n\n          <strong>{{item.room.name}}</strong>\n          <br/>\n          <i class=\"fa fa-calendar\"></i>{{ item.date}}\n\n      </div>\n    </div>\n\n  </div>\n</div>\n");
$templateCache.put("views/cinema-show.tpl.html","<div class=\"container\" id=\"show\">\n  <div class=\"row\">\n    <!-- info film -->\n    <div class=\"info-movie col-md-6\">\n      <img src=\"{{show.movie.Poster}}\" />\n      <h2>{{show.movie.Title}}</h2>\n      <p class=\"rating\"><span class=\"fa fa-star fa-1x\"></span>{{show.movie.imdbRating}}</p>\n    </div>\n    <div class=\"col-md-6\">\n      <h2>{{show.room.name}}</h2>\n    </div>\n  </div>\n  <div class=\"row\">\n\n    <h3>Seats</h3>\n    <p class=\"centered\"><i class=\"fa fa-circle\"></i><i class=\"fa fa-circle\"></i><i class=\"fa fa-circle\"></i></p>\n    <form id=\"seats\" ng-submit=\"show.send()\">\n\n      <div class=\"screen\"></div>\n\n      <div class=\"form-group\" ng-repeat=\"row in show.seats\">\n        <span class=\"seat\"\n              ng-class=\"{disabled: seat.desactivado, reserved: (seat.ocupado && !show.myseats[$parent.$index][$index].me), selected: show.myseats[$parent.$index][$index].me}\"\n              ng-repeat=\"seat in row track by $index\"\n              ng-click=\"( (seat.ocupado || seat.desactivado) && !show.myseats[$parent.$index][$index].me)  || changeStatus($parent.$index,$index)\"\n              ng-disabled=\"seat.desactivado && seat.ocupado\"\n              ng-model=\"seat\">\n        </span>\n      </div>\n\n      <div class=\"form-group text-center\">\n        <button class=\"btn btn-success btn-lg\" type=\"submit\">Buy</button>\n      </div>\n    </form>\n    <div class=\"col-lg-6 col-lg-offset-3\">\n    </div>\n  </div>\n</div>\n");}]);